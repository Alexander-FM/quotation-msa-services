name: CI/CD Materials Service

# ¿Cuándo se ejecuta esto?
on:
  push:
    branches: [ "develop", "master" ] # Se ejecuta al hacer push a estas ramas
    paths:
      - 'code/appmic-quotingplugins-materials/**' # ¡CLAVE! Solo si cambia algo DENTRO de la carpeta de materials
      - 'code/pom.xml' # O si cambia el pom padre
  # Permite ejecutarlo manualmente desde la web de GitHub si quieres
  workflow_dispatch:

# Definimos las variables globales
env:
  # Nombre de la imagen en DockerHub
  IMAGE_NAME: alexanderpe/appmic-quotingplugins-materials
  # Carpeta del servicio
  SERVICE_PATH: code/appmic-quotingplugins-materials

jobs:
  build-and-push:
    runs-on: ubuntu-latest # Usamos una máquina virtual Linux de GitHub

    steps:
      # 1. Descargar tu código del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Instalar Java (JDK 21 como usas tú)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven # Esto hace que las siguientes veces sea más rápido

      # 3. Compilar con Maven (CI)
      # Usamos -pl para indicar el proyecto específico y -am para incluir dependencias necesarias
      - name: Build with Maven
        # Entramos a la carpeta 'code' antes de ejecutar nada
        working-directory: ./code
        run: mvn clean package -DskipTests -pl appmic-quotingplugins-materials -am

      # 4. Iniciar sesión en Docker Hub (usando los secretos que creaste)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 5. Extraer metadatos para Docker (tags y etiquetas)
      # Esto genera tags como:latest y también un tag con el hash del commit (ej.:sha-a1b2c3d)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}

      # 6. Construir y Subir la imagen Docker (CD)
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ env.SERVICE_PATH }} # Dónde está el Dockerfile
          push: true # Subir a Docker Hub
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}